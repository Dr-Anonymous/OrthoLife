import{y as G,x as P,m as F,r as l,j as t}from"./index-DYCdECr2.js";import{H as y,F as w}from"./Footer-5CF68671.js";import{G as I}from"./GuidePostForm-3k0aYeKf.js";import{s as o}from"./client-opfxi3BE.js";import{S as m}from"./skeleton-DeYKIxXw.js";import"./index-DOA-4b-m.js";import"./phone-DAWZ9XqU.js";import"./RichTextEditor-SEif6zb0.js";import"./label-D6la_Z2I.js";import"./quote-CL5U8GGT.js";import"./link-JZZbcmPv.js";import"./minus-qXHcO3_K.js";import"./input-BlRor6HD.js";import"./textarea-CrPgbkNX.js";import"./tabs-C7V-UyVv.js";const K=()=>{const E=G(),{guideId:r}=P(),{toast:u}=F(),[N,x]=l.useState(!1),[f,S]=l.useState(null),[_,b]=l.useState(null),[v,h]=l.useState(!0);l.useEffect(()=>{(async()=>{if(r){h(!0);try{const{data:e,error:i}=await o.from("guides").select("*, categories(name)").eq("id",r).single();if(i)throw i;const{data:g,error:n}=await o.from("guide_translations").select("*").eq("guide_id",r);if(n)throw n;const c={...e,category_name:e.categories.name};S(c);const p=g.reduce((d,a)=>(d[a.language]={title:a.title,description:a.description,content:a.content,next_steps:a.next_steps},d),{});b(p)}catch(e){console.error("Error fetching guide data:",e),u({title:"Error",description:"Failed to fetch guide data.",variant:"destructive"})}finally{h(!1)}}})()},[r,u]);const D=async(j,e)=>{x(!0);try{const{category_name:i,...g}=j,{data:n,error:c}=await o.from("categories").select("id").eq("name",i).single();if(c&&c.code!=="PGRST116")throw c;const p=n?n.id:(await o.from("categories").insert({name:i}).select("id").single()).data.id,{error:d}=await o.from("guides").update({...g,category_id:p,last_updated:new Date().toISOString()}).eq("id",r);if(d)throw d;const a=Object.keys(e).map(s=>({guide_id:r,language:s,title:e[s].title,description:e[s].description,content:e[s].content,next_steps:e[s].next_steps}));if(a.length>0){const{error:s}=await o.from("guide_translations").upsert(a,{onConflict:"guide_id, language"});if(s)throw s}u({title:"Guide updated!",description:"The patient guide has been successfully updated."}),E(`/guides/${r}`)}catch(i){console.error("Error updating guide:",i),u({title:"Error",description:"There was an error updating the guide. Please try again.",variant:"destructive"})}finally{x(!1)}};return v?t.jsxs("div",{className:"min-h-screen flex flex-col",children:[t.jsx(y,{}),t.jsx("main",{className:"flex-grow bg-muted/50 pt-20",children:t.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-2xl",children:[t.jsx(m,{className:"h-8 w-1/2 mb-8"}),t.jsxs("div",{className:"space-y-8",children:[t.jsx(m,{className:"h-10 w-full"}),t.jsx(m,{className:"h-24 w-full"}),t.jsx(m,{className:"h-48 w-full"})]})]})}),t.jsx(w,{})]}):t.jsxs("div",{className:"min-h-screen flex flex-col",children:[t.jsx(y,{}),t.jsx("main",{className:"flex-grow bg-muted/50 pt-20",children:t.jsx("div",{className:"container mx-auto px-4 py-8",children:t.jsxs("div",{className:"max-w-2xl mx-auto",children:[t.jsx("h1",{className:"text-3xl font-heading font-bold text-primary mb-8",children:"Edit Patient Guide"}),f&&t.jsx(I,{initialData:f,translations:_,onSubmit:D,isSubmitting:N})]})})}),t.jsx(w,{})]})};export{K as default};
